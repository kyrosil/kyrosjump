<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>KyrosJump!</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #87CEEB;
            --bird-color: orange;
            --pipe-color: #006400;
            --text-color: #fff;
            --glow: none;
            --overlay-bg: rgba(0,0,0,0.7);
        }

        body.retro {
            --bg-color: #1a1a1a;
            --bird-color: #ff4040;
            --pipe-color: #00ff00;
            --text-color: #fff;
            --glow: 0 0 5px #00ff00;
            --overlay-bg: rgba(0,0,0,0.8);
            background: linear-gradient(to bottom, #1a1a1a, #2a2a2a);
        }

        body.cyberpunk {
            --bg-color: linear-gradient(45deg, #0d1b2a, #1b263b);
            --bird-color: #ff00ff;
            --pipe-color: #00f7ff;
            --text-color: #fff;
            --glow: 0 0 15px #ff00ff, 0 0 30px #ff00ff;
            --overlay-bg: rgba(0,0,0,0.9);
            background: var(--bg-color);
            animation: glitch-bg 5s infinite;
        }

        body.nature {
            --bg-color: #a8e6cf;
            --bird-color: #dcedc1;
            --pipe-color: #355e3b;
            --text-color: #000;
            --glow: 0 0 5px #dcedc1;
            --overlay-bg: rgba(255,255,255,0.7);
            background: linear-gradient(to bottom, #a8e6cf, #dcedc1);
        }

        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--bg-color);
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
            color: var(--text-color);
        }

        canvas {
            border: 1px solid #ccc;
            display: block;
            background: var(--bg-color);
            border-radius: 10px;
        }

        #gameContainer {
            position: relative;
            width: 320px;
            height: 480px;
            margin: auto;
            overflow: hidden;
            background: var(--bg-color);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            border-radius: 10px;
            max-width: 90vw;
            max-height: 80vh;
        }

        #gameOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--overlay-bg);
            backdrop-filter: blur(5px);
            color: var(--text-color);
            text-align: center;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 10;
            padding: 20px;
            box-sizing: border-box;
            border-radius: 10px;
        }

        #gameOverlay.visible {
            visibility: visible;
            opacity: 1;
        }

        #gameOverlay h2 {
            margin-bottom: 15px;
            font-size: 2em;
            font-weight: 700;
            animation: slideIn 1s ease;
        }

        #overlayText {
            margin-bottom: 20px;
            font-size: 1em;
            font-weight: 400;
            animation: fadeIn 1.5s ease;
        }

        #themeSelection {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }

        #themeSelection button {
            padding: 10px 20px;
            border: none;
            background: var(--bird-color);
            color: var(--text-color);
            cursor: pointer;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        #themeSelection button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        #randomCodeContainer {
            margin-top: 20px;
        }

        #randomCode {
            padding: 10px 15px;
            background: var(--text-color);
            color: #e74c3c;
            font-weight: bold;
            border-radius: 8px;
            font-size: 1.1em;
            user-select: all;
            display: inline-block;
        }

        #restartButton, #startButton {
            margin-top: 20px;
            padding: 12px 30px;
            font-size: 1.1em;
            cursor: pointer;
            border: none;
            color: var(--text-color);
            border-radius: 8px;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        #startButton {
            background: var(--bird-color);
        }

        #restartButton {
            background: var(--pipe-color);
        }

        #startButton:hover, #restartButton:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        .visible-logo-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .visible-logo {
            max-width: 200px;
            height: auto;
            border-radius: 10px;
            box-shadow: var(--glow);
            animation: pulse 2s infinite;
        }

        .main-title {
            color: var(--text-color);
            font-size: 2.5em;
            margin-bottom: 15px;
            font-weight: 700;
            text-align: center;
            animation: slideIn 1s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes glitch-bg {
            0% { background-position: 0 0; }
            50% { background-position: 5px 5px; }
            100% { background-position: 0 0; }
        }
    </style>
</head>
<body>
    <div style="display: flex; flex-direction: column; align-items: center; padding: 15px;">
        <h1 class="main-title">KyrosJump!</h1>
        <div id="gameContainer">
            <canvas id="gameCanvas" width="320" height="480"></canvas>
            <div id="gameOverlay">
                <div class="visible-logo-container">
                    <img id="overlayLogo" src="https://github.com/kyrosil/kyrosjump/blob/main/cropped-adsiz_tasarim-removebg-preview-1.png" alt="Kyrosil Logo" class="visible-logo">
                </div>
                <h2 id="overlayTitle">KyrosJump!</h2>
                <p id="overlayText">Kyros’un Zıplama Felsefesi: Her engel bir ders, her zıplama bir özgürlük!</p>
                <div id="themeSelection">
                    <button onclick="setTheme('retro')">Retro</button>
                    <button onclick="setTheme('cyberpunk')">Cyberpunk</button>
                    <button onclick="setTheme('nature')">Nature</button>
                </div>
                <div id="randomCodeContainer" style="display: none;">
                    Your Code: <span id="randomCode"></span>
                    <p style="font-size: 0.8em; margin-top: 10px;">(Save this code! You might need it!)</p>
                </div>
                <button id="restartButton" style="display: none;">Restart</button>
                <button id="startButton" disabled>Start Game</button>
            </div>
        </div>
    </div>

    <img id="imgKyrosil" src="https://github.com/kyrosil/kyrosjump/blob/main/cropped-adsiz_tasarim-removebg-preview-1.png" alt="Kyrosil Logo" style="display:none;">
    <img id="imgEU" src="https://github.com/kyrosil/kyrosjump/blob/main/download.jpg" alt="EU Logo" style="display:none;">
    <img id="imgNATO" src="https://github.com/kyrosil/kyrosjump/blob/main/OIP.jpg" alt="NATO Logo" style="display:none;">

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM Loaded. Initializing KyrosJump (v_FinalDebug)...");

        // --- Game Settings ---
        const birdProps = { x: 50, y: 150, width: 35, height: 35, gravity: 0.25, lift: -6, velocity: 0, color: getComputedStyle(document.documentElement).getPropertyValue('--bird-color').trim() };
        const pipeProps = { width: 50, gap: 140, color: getComputedStyle(document.documentElement).getPropertyValue('--pipe-color').trim(), speed: 2, frequency: 100 };
        const collectibleProps = { size: 20, score: 5 };
        const targetObstacles = 20;
        const minWinTimeSeconds = 30;
        const maxCollectiblesToSpawn = 6;
        const collectibleSpawnObstacles = [2, 5, 8, 11, 14, 17];
        let spawnedCollectiblesCount = 0;
        let pipes = [];
        let collectibles = [];
        let obstacleScore = 0;
        let collectibleScore = 0;
        let frames = 0;
        let gameState = 'loading';
        let startTime = null;
        let animationFrameId = null;
        const playLimitKey = 'kyrosJumpPlays_vFinalLocal';
        const lastPlayDateKey = 'kyrosJumpLastPlayDate_vFinal';
        const maxPlaysPerDay = 5;

        // --- Elements ---
        const canvas = document.getElementById('gameCanvas');
        if (!canvas || typeof canvas.getContext !== 'function') { console.error("FATAL: Canvas not found!"); return; }
        const ctx = canvas.getContext('2d');
        const overlay = document.getElementById('gameOverlay');
        const startButton = document.getElementById('startButton');
        const overlayTitle = document.getElementById('overlayTitle');
        const overlayText = document.getElementById('overlayText');
        const randomCodeContainer = document.getElementById('randomCodeContainer');
        const randomCodeSpan = document.getElementById('randomCode');
        const restartButton = document.getElementById('restartButton');
        const imgKyrosil = document.getElementById('imgKyrosil');
        const imgEU = document.getElementById('imgEU');
        const imgNATO = document.getElementById('imgNATO');

        if (!overlay || !overlayTitle || !overlayText || !randomCodeContainer || !randomCodeSpan || !restartButton || !startButton || !imgKyrosil || !imgEU || !imgNATO) {
            console.error("FATAL: One or more essential HTML elements missing!"); alert("Essential elements missing."); return; }
        console.log("All essential HTML elements found.");

        // --- Theme Management ---
        function setTheme(theme) {
            document.body.className = theme;
            localStorage.setItem('theme', theme);
            birdProps.color = getComputedStyle(document.documentElement).getPropertyValue('--bird-color').trim();
            pipeProps.color = getComputedStyle(document.documentElement).getPropertyValue('--pipe-color').trim();
        }

        let savedTheme = localStorage.getItem('theme') || 'retro';
        setTheme(savedTheme);

        // --- Image Preloading ---
        const imagesToLoad = [imgKyrosil, imgEU, imgNATO];
        let imagesLoaded = false;
        let loadedCount = 0;
        let errorCount = 0;
        const totalImages = imagesToLoad.filter(img => img).length;

        if (totalImages > 0) {
            console.log(`Attempting to load ${totalImages} images...`);
            function checkAllImagesLoaded() {
                loadedCount++;
                console.log(`Image check progress: ${loadedCount}/${totalImages}`);
                if (loadedCount >= totalImages) {
                    console.log(`Asset loading complete. Errors: ${errorCount}`);
                    imagesLoaded = true;
                    if (errorCount > 0) console.warn("Some images failed to load!");
                    if (gameState === 'loading' || gameState === 'start') {
                        gameState = 'start';
                        initScreenUpdate();
                    }
                }
            }
            imagesToLoad.forEach(img => {
                if (!img) {
                    console.error("Null image element");
                    loadedCount++;
                    return;
                }
                if (!img.src || img.src.endsWith('/')) {
                    console.error(`Image ${img.id} has invalid src: ${img.src}`);
                    errorCount++;
                    checkAllImagesLoaded();
                    return;
                }
                console.log(`Checking image: ${img.id} src: ${img.src}`);
                if (img.complete && img.naturalHeight !== 0) {
                    console.log(`Image ${img.id} already complete.`);
                    setTimeout(checkAllImagesLoaded, 0);
                } else {
                    img.onload = () => {
                        console.log(`Loaded: ${img.id}`);
                        checkAllImagesLoaded();
                    };
                    img.onerror = () => {
                        console.error(`ERROR loading: ${img.id}`);
                        errorCount++;
                        checkAllImagesLoaded();
                    };
                }
            });
            if (loadedCount >= totalImages && !imagesLoaded) {
                console.log("All images were already complete (initial check).");
                imagesLoaded = true;
                if (gameState === 'loading') gameState = 'start';
            }
        } else {
            console.log("No images to load.");
            imagesLoaded = true;
            gameState = 'start';
        }

        // --- Skor Tablosu ---
        function saveHighScore() {
            let highScore = parseInt(localStorage.getItem('highScore') || '0', 10);
            let totalScore = obstacleScore + collectibleScore;
            if (totalScore > highScore) {
                localStorage.setItem('highScore', totalScore);
            }
        }

        function getHighScore() {
            return parseInt(localStorage.getItem('highScore') || '0', 10);
        }

        // --- Generate 100 Prize Codes ---
        function generateRandomKyrosilCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = 'KYROSIL-';
            for (let i = 0; i < 5; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        const prizeCodes = new Set();
        while (prizeCodes.size < 100) {
            prizeCodes.add(generateRandomKyrosilCode());
        }
        const prizeCodeArray = Array.from(prizeCodes);

        // --- Game Functions ---
        function checkPlayLimit() {
            const today = new Date().toDateString();
            const lastPlayDate = localStorage.getItem(lastPlayDateKey);
            let plays = parseInt(localStorage.getItem(playLimitKey) || '0', 10);
            if (lastPlayDate !== today) {
                plays = 0;
                localStorage.setItem(lastPlayDateKey, today);
                localStorage.setItem(playLimitKey, '0');
            }
            if (plays >= maxPlaysPerDay) {
                return false;
            }
            return true;
        }

        function incrementPlayCount() {
            const today = new Date().toDateString();
            const lastPlayDate = localStorage.getItem(lastPlayDateKey);
            if (lastPlayDate !== today) {
                localStorage.setItem(lastPlayDateKey, today);
                localStorage.setItem(playLimitKey, '1');
            } else {
                let plays = parseInt(localStorage.getItem(playLimitKey) || '0', 10);
                plays++;
                localStorage.setItem(playLimitKey, plays.toString());
                console.log(`Play count: ${plays}/${maxPlaysPerDay}`);
            }
        }

        function resetGame() {
            console.log(">>> resetGame() function entered. <<<");
            if (!imagesLoaded) {
                console.warn("Reset blocked: Images not ready.");
                alert("Assets still loading...");
                return;
            }
            if (!checkPlayLimit()) {
                showOverlay('Limit Reached!', `Daily play limit (${maxPlaysPerDay}) reached. Try again tomorrow!`, false, false);
                return;
            }
            console.log("Resetting game variables...");
            birdProps.y = 150;
            birdProps.velocity = 0;
            pipes = [];
            collectibles = [];
            obstacleScore = 0;
            collectibleScore = 0;
            frames = 0;
            startTime = Date.now();
            spawnedCollectiblesCount = 0;
            gameState = 'playing';
            console.log("Gamestate set to 'playing'. Hiding overlay.");
            hideOverlay();
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            console.log("Starting game loop from reset...");
            loop();
        }

        function birdJump() {
            if (gameState === 'playing') birdProps.velocity = birdProps.lift;
        }

        function updatePipesAndCollectibles() {
            if (frames % pipeProps.frequency === 0) {
                let pipeY = Math.floor(Math.random() * (canvas.height - pipeProps.gap - 100)) + 50;
                pipes.push({ x: canvas.width, y: 0, height: pipeY, passed: false });
                pipes.push({ x: canvas.width, y: pipeY + pipeProps.gap, height: canvas.height - pipeY - pipeProps.gap, passed: false });
                if (collectibleSpawnObstacles.includes(obstacleScore) && spawnedCollectiblesCount < maxCollectiblesToSpawn) {
                    const collectibleType = Math.random() < 0.5 ? 'EU' : 'NATO';
                    const collectibleImg = collectibleType === 'EU' ? imgEU : imgNATO;
                    const collectibleY = pipeY + (pipeProps.gap / 2) - (collectibleProps.size / 2) + (Math.random() * 30 - 15);
                    const collectibleX = canvas.width + pipeProps.width;
                    if (collectibleImg && collectibleImg.complete && collectibleImg.naturalHeight !== 0) {
                        collectibles.push({ x: collectibleX, y: collectibleY, type: collectibleType, img: collectibleImg, collected: false, offscreen: false });
                        spawnedCollectiblesCount++;
                    }
                }
            }
            for (let i = pipes.length - 1; i >= 0; i--) {
                pipes[i].x -= pipeProps.speed;
                if (pipes[i].x + pipeProps.width < 0) pipes.splice(i, 1);
            }
            for (let i = collectibles.length - 1; i >= 0; i--) {
                collectibles[i].x -= pipeProps.speed;
                if (collectibles[i].x + collectibleProps.size < 0) collectibles[i].offscreen = true;
            }
        }

        function updateBird() {
            birdProps.velocity += birdProps.gravity;
            birdProps.y += birdProps.velocity;
            if (birdProps.y + birdProps.height > canvas.height) {
                birdProps.y = canvas.height - birdProps.height;
                birdProps.velocity = 0;
                setGameOver();
            }
            if (birdProps.y < 0) {
                birdProps.y = 0;
                birdProps.velocity = 0;
            }
        }

        function checkCollisions() {
            const bird = birdProps;
            for (const pipe of pipes) {
                if (bird.x < pipe.x + pipeProps.width && bird.x + bird.width > pipe.x && bird.y < pipe.y + pipe.height && bird.y + bird.height > pipe.y) {
                    setGameOver();
                    return;
                }
            }
            for (const item of collectibles) {
                if (!item.collected && !item.offscreen && bird.x < item.x + collectibleProps.size && bird.x + bird.width > item.x && bird.y < item.y + collectibleProps.size && bird.y + bird.height > item.y) {
                    item.collected = true;
                    collectibleScore += collectibleProps.score;
                }
            }
            for (let i = 0; i < pipes.length; i += 2) {
                const topPipe = pipes[i];
                if (!topPipe.passed && topPipe.x + pipeProps.width < bird.x) {
                    topPipe.passed = true;
                    if (pipes[i+1]) pipes[i+1].passed = true;
                    obstacleScore++;
                    if (obstacleScore >= targetObstacles) {
                        setWin();
                        return;
                    }
                }
            }
        }

        function drawBird() {
            if (imgKyrosil && imgKyrosil.complete && imgKyrosil.naturalHeight !== 0 && imgKyrosil.src) {
                let angle = birdProps.velocity / 10;
                angle = Math.max(-Math.PI / 6, Math.min(Math.PI / 4, angle));
                ctx.save();
                ctx.translate(birdProps.x + birdProps.width / 2, birdProps.y + birdProps.height / 2);
                ctx.rotate(angle);
                // Simulate wing flap
                const flap = Math.sin(frames / 5) * 0.1 + 1;
                ctx.scale(flap, 1 / flap);
                try {
                    ctx.drawImage(imgKyrosil, -birdProps.width / 2, -birdProps.height / 2, birdProps.width, birdProps.height);
                } catch(e) {
                    console.error("Draw Kyrosil Error:", e);
                    ctx.fillStyle = birdProps.color;
                    ctx.fillRect(-birdProps.width / 2, -birdProps.height / 2, birdProps.width, birdProps.height);
                }
                ctx.restore();
            } else {
                ctx.fillStyle = birdProps.color;
                ctx.fillRect(birdProps.x, birdProps.y, birdProps.width, birdProps.height);
                if (frames % 120 === 0) {
                    console.warn("Drawing fallback bird.");
                }
            }
        }

        function drawPipes() {
            ctx.fillStyle = pipeProps.color;
            pipes.forEach(pipe => {
                ctx.globalAlpha = Math.max(0.5, 1 - (canvas.width - pipe.x) / canvas.width);
                ctx.fillRect(pipe.x, pipe.y, pipeProps.width, pipe.height);
                ctx.globalAlpha = 1;
            });
        }

        function drawCollectibles() {
            collectibles.forEach(item => {
                if (!item.collected && !item.offscreen && item.img && item.img.complete && item.img.naturalHeight !== 0) {
                    try {
                        ctx.drawImage(item.img, item.x, item.y, collectibleProps.size, collectibleProps.size);
                    } catch(e) {
                        console.error(`Draw Collectible Error ${item.type}:`, e);
                        ctx.fillStyle = (item.type === 'EU' ? '#003399' : '#4A4A4A');
                        ctx.fillRect(item.x, item.y, collectibleProps.size, collectibleProps.size);
                    }
                }
            });
        }

        function drawScore() {
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 0.5;
            ctx.font = 'bold 16px Poppins';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            const obsText = `Obstacles: ${obstacleScore}/${targetObstacles}`;
            const bonusText = `Bonus: ${collectibleScore}`;
            const highScoreText = `High Score: ${getHighScore()}`;
            ctx.strokeText(obsText, 10, 10);
            ctx.fillText(obsText, 10, 10);
            ctx.strokeText(bonusText, 10, 30);
            ctx.fillText(bonusText, 10, 30);
            ctx.strokeText(highScoreText, 10, 50);
            ctx.fillText(highScoreText, 10, 50);
        }

        function checkWinConditions() {
            const endTime = Date.now();
            const elapsedTimeSeconds = (endTime - startTime) / 1000;
            if (!startTime || elapsedTimeSeconds < minWinTimeSeconds) {
                console.warn(`Anti-Cheat: Time (${elapsedTimeSeconds.toFixed(1)}s) < Min (${minWinTimeSeconds}s).`);
                return false;
            }
            return true;
        }

        function showOverlay(title, text, showStart, showRestart, randomCode = '') {
            if (!overlay || !overlayTitle || !overlayText || !startButton || !restartButton || !randomCodeContainer || !randomCodeSpan) {
                console.error("Overlay elements missing!");
                return;
            }
            console.log(`Show Overlay: Title='${title}', Text='${text}', StartBtn=${showStart}, RestartBtn=${showRestart}, Code='${randomCode}'`);
            overlayTitle.textContent = title;
            overlayText.textContent = text;
            startButton.style.display = showStart ? 'inline-block' : 'none';
            restartButton.style.display = showRestart ? 'inline-block' : 'none';
            if (randomCode) {
                randomCodeSpan.textContent = randomCode;
                randomCodeContainer.style.display = 'block';
            } else {
                randomCodeContainer.style.display = 'none';
            }
            overlay.classList.add('visible');
        }

        function hideOverlay() {
            console.log("Hiding overlay.");
            if (overlay) overlay.classList.remove('visible');
        }

        function setGameOver() {
            if (gameState === 'gameover' || gameState === 'win') return;
            console.log("Game Over");
            gameState = 'gameover';
            playSound(loseSound);
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            incrementPlayCount();
            saveHighScore();
            showOverlay('Game Over!', `Obstacles: ${obstacleScore} | Bonus: ${collectibleScore} | High Score: ${getHighScore()}`, false, true);
        }

        function setWin() {
            if (gameState === 'win' || gameState === 'gameover') return;
            console.log("Win condition met!");
            if (checkWinConditions()) {
                gameState = 'win';
                playSound(winSound);
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
                incrementPlayCount();
                saveHighScore();
                const totalScore = obstacleScore + collectibleScore;
                const randomCode = prizeCodeArray[Math.floor(Math.random() * prizeCodeArray.length)];
                console.log(`Win! Score: ${totalScore}, Code: ${randomCode}`);
                showOverlay('🎉 Congratulations! 🎉', `Final Score: ${totalScore} (Obstacles: ${obstacleScore} + Bonus: ${collectibleScore}) | High Score: ${getHighScore()}`, false, true, randomCode);
            } else {
                console.log("Anti-cheat check failed.");
                setGameOver();
                if (overlayText) overlayText.textContent = `Score: ${obstacleScore + collectibleScore}. Anti-cheat check failed.`;
            }
        }

        // --- Game Loop ---
        function loop(timestamp) {
            if (gameState !== 'playing') {
                return;
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            updatePipesAndCollectibles();
            updateBird();
            checkCollisions();
            drawPipes();
            drawCollectibles();
            drawBird();
            drawScore();
            frames++;
            animationFrameId = requestAnimationFrame(loop);
        }

        // --- Init and Event Listeners ---
        function spacebarHandler(e) {
            if (!imagesLoaded) return;
            if (e.code === 'Space') {
                e.preventDefault();
                if (gameState === 'start' && checkPlayLimit()) {
                    resetGame();
                } else if (gameState === 'playing') {
                    birdJump();
                }
            }
        }

        function initScreenUpdate() {
            if (!overlay || !startButton || !overlayText) {
                console.error("Cannot update screen: elements missing!");
                return;
            }
            const canPlay = checkPlayLimit();
            const plays = parseInt(localStorage.getItem(playLimitKey) || '0', 10);
            const playsRemaining = maxPlaysPerDay - plays;
            let startText = 'Kyros’un Zıplama Felsefesi: Her engel bir ders, her zıplama bir özgürlük!';
            if (imagesLoaded) {
                startText += `\nPlays remaining today: ${canPlay ? playsRemaining : 0}`;
                if (!canPlay) {
                    startText = `Daily play limit (${maxPlaysPerDay}) reached. Try again tomorrow!`;
                }
            } else {
                startText = 'Loading Assets... Please Wait...';
            }
            console.log("Updating overlay text:", startText);
            showOverlay('KyrosJump!', startText, (canPlay && imagesLoaded), false);
            if (startButton) {
                startButton.disabled = !imagesLoaded || !canPlay;
                if (!canPlay && imagesLoaded) {
                    startButton.style.display = 'none';
                } else {
                    startButton.style.display = 'inline-block';
                }
            }
        }

        function init() {
            console.log(">>> init() function entered.");
            gameState = 'start';
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            hideOverlay();
            initScreenUpdate();
            function clickOrTapHandler(e) {
                if (imagesLoaded) {
                    if (gameState === 'start' && checkPlayLimit()) {
                        resetGame();
                    } else if (gameState === 'playing') {
                        birdJump();
                    }
                }
                if (e.type === 'touchstart') e.preventDefault();
            }
            canvas.removeEventListener('click', clickOrTapHandler);
            canvas.removeEventListener('touchstart', clickOrTapHandler);
            canvas.addEventListener('click', clickOrTapHandler);
            canvas.addEventListener('touchstart', clickOrTapHandler);

            console.log("Setting up Start Button listener inside init...");
            if (!startButton) {
                console.error("CRITICAL: Start Button is NULL in init!");
                return;
            }
            startButton.onclick = function() {
                console.log("--- Start Button Clicked! ---");
                const currentState = gameState;
                const currentLoaded = imagesLoaded;
                const currentCanPlay = checkPlayLimit();
                console.log(`Checking conditions: gameState='${currentState}', imagesLoaded=${currentLoaded}, canPlay=${currentCanPlay}`);
                if (currentState === 'start' && currentLoaded && currentCanPlay) {
                    console.log("Conditions MET! Calling resetGame()...");
                    resetGame();
                } else {
                    console.error(`Start button ignored! Reason(s):`);
                    if (currentState !== 'start') {
                        console.error(` - gameState is NOT 'start' (it is '${currentState}')`);
                        alert(`Cannot start game. Current state: ${currentState}`);
                    }
                    if (!currentLoaded) {
                        console.error(` - imagesLoaded is FALSE`);
                        alert("Assets still loading, please wait or check console for errors.");
                    }
                    if (!currentCanPlay) {
                        console.error(` - checkPlayLimit() returned FALSE`);
                        alert(`Daily play limit (${maxPlaysPerDay}) reached! Try again tomorrow.`);
                    }
                }
            };
            console.log("Start Button listener attached.");

            restartButton.onclick = function() {
                console.log("Restart clicked.");
                if ((gameState === 'gameover' || gameState === 'win') && imagesLoaded) {
                    init();
                }
            };
            window.removeEventListener('keydown', spacebarHandler);
            window.addEventListener('keydown', spacebarHandler);
        }

        // --- Sounds (Placeholder) ---
        const loseSound = null;
        const winSound = null;
        function playSound(soundElement) {
            if (soundElement?.play) {
                soundElement.currentTime = 0;
                soundElement.play().catch(e => console.warn("Sound play failed:", e));
            }
        }

        // --- Initial Start ---
        console.log("Setting initial game state to 'loading'.");
        gameState = 'loading';
        init();
    });
</script>
</body>
</html>
