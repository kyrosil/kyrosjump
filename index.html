<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>KyrosJump! (No Image Load)</title>
    <style>
        /* CSS unchanged */
        body { margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f0f0f0; font-family: sans-serif; overflow: hidden; }
        canvas { border: 1px solid #ccc; display: block; background-color: #87CEEB; }
        #gameContainer { position: relative; width: 360px; height: 540px; margin: auto; overflow: hidden; background-color: #87CEEB; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid #ccc;}
        #gameOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.7); color: white; text-align: center; visibility: hidden; opacity: 0; transition: opacity 0.3s ease, visibility 0s linear 0.3s; font-size: 1.3em; z-index: 10; padding: 15px; box-sizing: border-box; }
        #gameOverlay.visible { visibility: visible; opacity: 1; transition: opacity 0.3s ease; }
        #gameOverlay h2 { margin-bottom: 10px; font-size: 1.5em; }
        #overlayText { margin-bottom: 15px; font-size: 0.9em; }
        #prizeInfo { margin-top: 15px; font-weight: bold; color: #ffd700; font-size: 1.1em; }
        #randomCodeContainer { margin-top: 10px; }
        #randomCode { padding: 8px 12px; background-color: #fff; color: #e74c3c; font-weight: bold; border-radius: 5px; font-size: 1em; user-select: all; display: inline-block;}
        #restartButton, #startButton { margin-top: 20px; padding: 12px 25px; font-size: 0.9em; cursor: pointer; border: none; color: white; border-radius: 5px; }
        #startButton { background-color: #2ecc71;}
        #restartButton { background-color: #3498db;}
        .visible-logo-container { text-align: center; margin-bottom: 15px; padding-top: 15px; }
        .visible-logo { max-width: 150px; height: auto; border-radius: 5px; }
        .main-title { color: #2c3e50; font-size: 2em; margin-bottom: 10px; font-weight: 600; text-align: center; }
        @media (max-width: 400px) { .visible-logo-container { display: none; } #gameContainer { margin-top: 0px; } .main-title { margin-bottom: 5px;} h1.main-title {font-size: 1.6em;} #gameOverlay {font-size: 1.1em;} #gameOverlay h2 { font-size: 1.3em; } }
    </style>
</head>
<body>
     <div style="display: flex; flex-direction: column; align-items: center; padding: 10px;">
        <h1 class="main-title">KyrosJump!</h1>
        <div class="visible-logo-container">
             <img class="visible-logo" src="slider_picture_1.png" alt="Yunandan Gelsin"> </div>
         <div id="gameContainer">
             <canvas id="gameCanvas" width="360" height="540"></canvas>
             <div id="gameOverlay">
                 <h2 id="overlayTitle">KyrosJump!</h2>
                 <p id="overlayText">Initializing...</p> <div id="prizeInfo" style="display: none;"></div>
                 <div id="randomCodeContainer" style="display: none;">
                     Your Claim Code: <span id="randomCode"></span>
                     <p style="font-size: 0.7em; margin-top: 8px;">(Save this code!)</p>
                 </div>
                 <button id="restartButton" style="display: none;">Restart</button>
                 <button id="startButton">Start Game</button>
             </div>
         </div>
     </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM Loaded. Initializing KyrosJump (v_FixUpdatePipes)...");

        // --- Essential Elements ---
        const canvas = document.getElementById('gameCanvas');
        if (!canvas || typeof canvas.getContext !== 'function') { console.error("FATAL: Canvas not found!"); return; }
        const ctx = canvas.getContext('2d');
        const overlay = document.getElementById('gameOverlay');
        const startButton = document.getElementById('startButton');
        const overlayTitle = document.getElementById('overlayTitle');
        const overlayText = document.getElementById('overlayText');
        const randomCodeContainer = document.getElementById('randomCodeContainer');
        const randomCodeSpan = document.getElementById('randomCode');
        const restartButton = document.getElementById('restartButton');
        // Image elements are not needed by JS in this version
        console.log("Essential elements checked.");

        // --- Game Settings ---
        const birdProps = { x: 60, y: 150, width: 35, height: 35, color: 'orange', gravity: 0.35, lift: -7, velocity: 0 };
        const pipeProps = { width: 60, gap: 120, color: '#006400', speed: 2.5, frequency: 85 };
        // Collectibles REMOVED from this version
        const targetObstacles = 20;
        const minWinTimeSeconds = 25;
        let pipes = [];
        let obstacleScore = 0;
        let frames = 0; let gameState = 'loading'; let startTime = null; let animationFrameId = null;
        const playLimitKey = 'kyrosJumpPlays_vSimpleFix'; const lastPlayDateKey = 'kyrosJumpLastPlayDate_vSF'; const maxPlaysPerDay = 5;

        // --- Prize Codes ---
        function generateRandomKyrosilCode() { const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let code = 'KYROSIL-'; for (let i = 0; i < 5; i++) { code += chars.charAt(Math.floor(Math.random() * chars.length)); } return code; }
        const prizeCodes = new Set(); while (prizeCodes.size < 100) { prizeCodes.add(generateRandomKyrosilCode()); }
        const prizeCodeArray = Array.from(prizeCodes);

        // --- Game Functions ---
         function checkPlayLimit() { const today = new Date().toDateString(); const lastPlayDate = localStorage.getItem(lastPlayDateKey); let plays = parseInt(localStorage.getItem(playLimitKey) || '0', 10); if (lastPlayDate !== today) { plays = 0; localStorage.setItem(lastPlayDateKey, today); localStorage.setItem(playLimitKey, '0'); } if (plays >= maxPlaysPerDay) { return false; } return true; }
         function incrementPlayCount() { const today = new Date().toDateString(); const lastPlayDate = localStorage.getItem(lastPlayDateKey); if (lastPlayDate !== today) { localStorage.setItem(lastPlayDateKey, today); localStorage.setItem(playLimitKey, '1'); } else { let plays = parseInt(localStorage.getItem(playLimitKey) || '0', 10); plays++; localStorage.setItem(playLimitKey, plays.toString()); console.log(`Play count: ${plays}/${maxPlaysPerDay}`); } }

         // CORRECTED updatePipes function definition
         function updatePipes() {
             if (frames % pipeProps.frequency === 0) {
                 let pipeY = Math.floor(Math.random() * (canvas.height - pipeProps.gap - 150)) + 75;
                 pipes.push({ x: canvas.width, y: 0, height: pipeY, passed: false });
                 pipes.push({ x: canvas.width, y: pipeY + pipeProps.gap, height: canvas.height - pipeY - pipeProps.gap, passed: false });
             }
             for (let i = pipes.length - 1; i >= 0; i--) {
                 pipes[i].x -= pipeProps.speed;
                 if (pipes[i].x + pipeProps.width < 0) {
                     pipes.splice(i, 1);
                 }
             }
         }

         function resetGame() {
             console.log(">>> resetGame entered (Simple)");
             if (!checkPlayLimit()) { showOverlay('Limit Reached!', `Daily play limit (${maxPlaysPerDay}) reached. Try again tomorrow!`, false, false); return; }
             birdProps.y = 150; birdProps.velocity = 0; pipes = []; obstacleScore = 0; frames = 0; startTime = Date.now();
             gameState = 'playing';
             hideOverlay();
             if (animationFrameId) cancelAnimationFrame(animationFrameId);
             console.log("Starting game loop (Simple)...");
             loop();
         }
         function birdJump() { if (gameState === 'playing') birdProps.velocity = birdProps.lift; }
         function updateBird() { birdProps.velocity += birdProps.gravity; birdProps.y += birdProps.velocity; if (birdProps.y + birdProps.height > canvas.height) { birdProps.y = canvas.height - birdProps.height; birdProps.velocity = 0; setGameOver(); } if (birdProps.y < 0) { birdProps.y = 0; birdProps.velocity = 0; } }
         // Simplified collision - No Collectibles
         function checkCollisions() { const bird = birdProps; for (const pipe of pipes) { if (bird.x < pipe.x + pipeProps.width && bird.x + bird.width > pipe.x && bird.y < pipe.y + pipe.height && bird.y + bird.height > pipe.y) { setGameOver(); return; } } for (let i = 0; i < pipes.length; i += 2) { const topPipe = pipes[i]; if (!topPipe.passed && topPipe.x + pipeProps.width < bird.x) { topPipe.passed = true; if(pipes[i+1]) pipes[i+1].passed = true; obstacleScore++; if (obstacleScore >= targetObstacles) { setWin(); return; } } } }
         // Simplified drawBird - ALWAYS orange square
         function drawBird() { ctx.fillStyle = birdProps.color; ctx.fillRect(birdProps.x, birdProps.y, birdProps.width, birdProps.height); }
         function drawPipes() { ctx.fillStyle = pipeProps.color; pipes.forEach(pipe => { ctx.fillRect(pipe.x, pipe.y, pipeProps.width, pipe.height); }); }
         // Simplified score drawing
         function drawScore() { ctx.fillStyle = '#fff'; ctx.strokeStyle = '#000'; ctx.lineWidth= 0.5; ctx.font = 'bold 18px Arial'; ctx.textAlign = 'left'; ctx.textBaseline = 'top'; const obsText = `Obstacles: ${obstacleScore}/${targetObstacles}`; ctx.strokeText(obsText, 10, 10); ctx.fillText(obsText, 10, 10); }
         function checkWinConditions() { const endTime = Date.now(); const elapsedTimeSeconds = (endTime - startTime) / 1000; if (!startTime || elapsedTimeSeconds < minWinTimeSeconds) { console.warn(`Anti-Cheat: Time (${elapsedTimeSeconds.toFixed(1)}s) < Min (${minWinTimeSeconds}s).`); return false; } return true; }

         function showOverlay(title, text, showStart, showRestart, randomCode = '') {
             if(!overlay || !overlayTitle || !overlayText || !startButton || !restartButton || !randomCodeContainer || !randomCodeSpan) { return; }
             overlayTitle.textContent = title;
             overlayText.textContent = text;
             // Ensure button state is managed correctly based on 'showStart' and 'canPlay'
             const canPlay = checkPlayLimit(); // Check limit again when showing overlay
             startButton.style.display = showStart ? 'inline-block' : 'none';
             if (showStart && startButton) startButton.disabled = !canPlay; // Disable if limit reached
             restartButton.style.display = showRestart ? 'inline-block' : 'none';
             if (prizeInfoSpan) prizeInfoSpan.style.display = 'none'; // Hide prize info span
             if (randomCode) { randomCodeSpan.textContent = randomCode; randomCodeContainer.style.display = 'block'; }
             else { randomCodeContainer.style.display = 'none'; }
             overlay.classList.add('visible');
         }
         function hideOverlay() { if(overlay) overlay.classList.remove('visible'); }
         // Simplified GameOver - No Bonus Score
         function setGameOver() { if (gameState === 'gameover' || gameState === 'win') return; console.log("Game Over"); gameState = 'gameover'; playSound(loseSound); if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null;} incrementPlayCount(); showOverlay('Game Over!', `Obstacles Passed: ${obstacleScore}`, false, true); }

         // Simplified setWin - NO Tiers, NO Formspree, ONLY Random Code
         function setWin() {
             if (gameState === 'win' || gameState === 'gameover') return;
             console.log("Win condition met!");
             if (checkWinConditions()) {
                 gameState = 'win';
                 playSound(winSound);
                 if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null;}
                 incrementPlayCount();
                 const randomCode = prizeCodeArray[Math.floor(Math.random() * prizeCodeArray.length)];
                 console.log(`Win! Obstacles: ${obstacleScore}, Code: ${randomCode}`);
                 showOverlay('🎉 Congratulations! 🎉', `You passed all ${targetObstacles} obstacles!`, false, true, randomCode);
                 // Formspree call REMOVED
             } else {
                 console.log("Anti-cheat check failed.");
                 setGameOver();
                 if(overlayText) overlayText.textContent = `Obstacles: ${obstacleScore}. Anti-cheat check failed.`;
             }
         }

        // Game Loop - FIXED to call updatePipes()
        function loop(timestamp) {
            if (gameState !== 'playing') { return; }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            updatePipes(); // <-- *** BURASI DÜZELTİLDİ ***
            updateBird();
            checkCollisions();
            drawPipes();
            // drawCollectibles removed
            drawBird();
            drawScore();
            frames++;
            animationFrameId = requestAnimationFrame(loop);
        }

        // --- Init and Event Listeners ---
        const spacebarHandler = (e) => { /* imagesLoaded removed */ if (e.code === 'Space') { e.preventDefault(); if (gameState === 'start' && checkPlayLimit()) { resetGame(); } else if (gameState === 'playing') { birdJump(); } } };
        function initScreenUpdate() {
             if (!overlay || !startButton || !overlayText) return;
             const canPlay = checkPlayLimit();
             const plays = parseInt(localStorage.getItem(playLimitKey) || '0', 10);
             const playsRemaining = maxPlaysPerDay - plays;
             let startText = `Plays remaining today: ${canPlay ? playsRemaining : 0}`; // No loading message
             if (!canPlay) { startText = `Daily play limit (${maxPlaysPerDay}) reached. Try again tomorrow!`; }
             console.log("Updating overlay text (No Img Load):", startText);
             showOverlay('KyrosJump!', startText, canPlay, false); // Show start if canPlay
             if(startButton) { startButton.disabled = !canPlay; if (!canPlay) { startButton.style.display = 'none'; } else { startButton.style.display = 'inline-block'; } }
        }
        function init() {
             console.log(">>> init() function entered (No Img Load).");
             gameState = 'start';
             if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
             hideOverlay();
             initScreenUpdate(); // Update screen immediately

             const clickOrTapHandler = (e) => {
                 // No imagesLoaded check needed
                 if (gameState === 'start' && checkPlayLimit()) { resetGame(); }
                 else if (gameState === 'playing') { birdJump(); }
                 if (e.type === 'touchstart') e.preventDefault();
             };
             canvas.removeEventListener('click', clickOrTapHandler); canvas.removeEventListener('touchstart', clickOrTapHandler);
             canvas.addEventListener('click', clickOrTapHandler); canvas.addEventListener('touchstart', clickOrTapHandler);

             // Keep DEBUG alerts in start button for now
             startButton.onclick = () => {
                 alert("--- Start Button Clicked! ---");
                 const currentState = gameState;
                 const currentCanPlay = checkPlayLimit();
                 alert(`Checking: State='${currentState}', CanPlay=${currentCanPlay}`);
                 if (currentState === 'start' && currentCanPlay) {
                     alert("Conditions MET! Calling resetGame()...");
                     resetGame();
                 } else {
                     let blockReason = "Start button ignored! Reason(s):\n";
                     if (currentState !== 'start') blockReason += `- Game state is not 'start' ('${currentState}')\n`;
                     if (!currentCanPlay) blockReason += `- Play limit reached\n`;
                     console.error(blockReason); alert(blockReason);
                 }
             };
             console.log("Start Button listener attached.");

             restartButton.onclick = () => { console.log("Restart clicked."); if (gameState === 'gameover' || gameState === 'win') { init(); } };
             window.removeEventListener('keydown', spacebarHandler); window.addEventListener('keydown', spacebarHandler);
         }

        // --- Sounds (Placeholder) ---
        const loseSound = null; const winSound = null; function playSound(soundElement) { if (soundElement?.play) { soundElement.currentTime = 0; soundElement.play().catch(e => console.warn("Sound play failed:", e)); } }
        // --- Formspree function REMOVED ---

        // --- Initial Start ---
        console.log("Running init() immediately (No Image Wait).");
        gameState = 'start';
        init(); // Call init directly

    }); // END of DOMContentLoaded listener
</script>

</body>
</html>
